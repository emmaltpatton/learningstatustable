<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Learning Status Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ Correct Jotform Custom Widget API include -->
  <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

  <style>
    :root{
      /* Core colours */
      --header-color: #0c2340;
      --row-alt-color: rgba(12,35,64,.2);
      --border: #c8c8c8;
      --text: #222;

      /* Typography (can be driven by settings) */
      --form-font-family: Inter, sans-serif;
      --form-font-size: 14px;

      /* text colours driven by settings */
      --section-title-font-color: #ffffff; /* title bar text */
      --th-font-color: #ffffff;            /* <th> text */
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 12px;
      background: transparent;
      color: var(--text);
      font-family: var(--form-font-family) !important;
      font-size: var(--form-font-size);
      line-height: 1.4;
    }

    /* Title bar above the table */
    .section-title{
      margin: 0 0 8px 0;
      font-weight: 700;
      font-size: 15px;
      color: var(--section-title-font-color);
      background: var(--header-color);
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-bottom: 0;
      border-radius: 2px 2px 0 0;
    }

    .table-wrap { overflow: auto; }
    table { width: 100%; border-collapse: collapse; border: 1px solid var(--border); background: #fff; }

    thead th {
      text-align: left;
      padding: 8px 10px;
      color: var(--th-font-color);
      background: var(--header-color);
      border-bottom: 1px solid var(--border);
      font-family: var(--form-font-family) !important;
      font-weight: 700;
    }

    tbody td {
      vertical-align: top; padding: 6px 10px;
      border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); background: #fff;
    }
    tbody tr:nth-child(even) td { background: var(--row-alt-color); }
    tbody tr:last-child td { border-bottom: 0; }
    tbody td:last-child, thead th:last-child { border-right: 0; }

    .task-html a { color: #84bd00; text-decoration: underline; }

    .status-list { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 4px; }
    .status-list label { white-space: nowrap; cursor: pointer; }

    input[type="date"]{
      width: 100%; min-width: 12ch; padding: 4px 6px;
      border: 1px solid #bfbfbf; border-radius: 3px; background: #fff;
    }

    table, th, td, label, input, button, select, textarea {
      font-family: var(--form-font-family) !important;
      font-size: var(--form-font-size);
      color: var(--text);
    }
  </style>
</head>
<body>

  <div id="sectionTitle" class="section-title" role="heading" aria-level="2"></div>

  <div class="table-wrap">
    <table id="statusTable" aria-describedby="sectionTitle">
      <thead>
        <tr>
          <th id="col_task">Task</th>
          <th id="col_status">Status</th>
          <th id="col_date">Date</th>
        </tr>
      </thead>
      <tbody id="tableBody"><tr><td>Loading…</td></tr></tbody>
    </table>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);

    function renderHeaderTitle() {
      const box = document.getElementById('sectionTitle');
      if (!box) return;
      const title = (settings.headerTitle || '').trim();
      if (title) { box.textContent = title; box.style.display = ''; }
      else { box.style.display = 'none'; }
    }

    function hexToRgb(hex) {
      const m = (hex || '').trim().replace(/^#/, '').match(/^([0-9a-f]{3}|[0-9a-f]{6})$/i);
      if (!m) return {r:12,g:35,b:64};
      let h = m[1];
      if (h.length === 3) h = h.split('').map(x => x + x).join('');
      const int = parseInt(h, 16);
      return { r: (int >> 16) & 255, g: (int >> 8) & 255, b: int & 255 };
    }
    function tintFromHex(hex, alpha = .1) {
      const {r,g,b} = hexToRgb(hex);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    function stripHtml(html) {
      const d = document.createElement('div'); d.innerHTML = html || '';
      return (d.textContent || d.innerText || '').trim();
    }
    function parseLines(text) {
      if (!text) return [];
      return text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }
    function getRadioByValue(container, value) {
      const radios = container.querySelectorAll('input[type="radio"]');
      for (const r of radios) if (r.value === String(value)) return r;
      return null;
    }

    // --- PDF-safe helpers (left in place; not used for neat text submission) ---
    function escapeHtml(txt) {
      const d = document.createElement('div');
      d.textContent = String(txt ?? '');
      return d.innerHTML;
    }
    function sanitizeTaskHtml(html) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html || '';
      const allowed = new Set(['A','UL','LI','STRONG','EM','BR']);
      wrapper.querySelectorAll('*').forEach(node => {
        if (!allowed.has(node.tagName)) {
          const span = document.createElement('span');
          while (node.firstChild) span.appendChild(node.firstChild);
          node.replaceWith(span);
        }
      });
      wrapper.querySelectorAll('a[href]').forEach(a => {
        a.setAttribute('target', '_blank');
        a.setAttribute('rel', 'noopener noreferrer');
      });
      return wrapper.innerHTML;
    }

    // AU date helpers
    function isoToAU(iso) {
      if (!iso) return "";
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
      return m ? `${m[3]}/${m[2]}/${m[1]}` : "";
    }
    function todayAU() {
      const d = new Date();
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    }

    // ---------- Defaults (overridden by Widget Settings in Jotform) ----------
    let settings = {
      rowsContent:
        'Access Employee Portal within PageUp\n' +
        'Complete all Corporate Inductions in PageUp:<ul><li><a href="https://intranet/policy">Workplace Behaviour</a></li></ul>\n' +
        'Book into relevant learning activities in PageUp',
      statusOptions: 'Complete\nNot Applicable',
      headerColor: '#0c2340',
      headerTitle: 'INDUCTION',
      autoDateOnOptions: '',
      formFontFamily: 'Inter, sans-serif',
      formFontSize: '14px',
      sectionTitleFontColor: '#ffffff',
      thFontColor: '#ffffff'
    };
    let initialValue = null;

    // ---------- Look & feel ----------
    function applyTheme() {
      const root = document.documentElement;
      root.style.setProperty('--header-color', settings.headerColor);
      root.style.setProperty('--row-alt-color', tintFromHex(settings.headerColor, .1));
    }
    function applyTypography() {
      const root = document.documentElement;
      if (settings.formFontFamily) root.style.setProperty('--form-font-family', settings.formFontFamily);
      if (settings.formFontSize)   root.style.setProperty('--form-font-size', settings.formFontSize);
    }
    function applyWidgetColors() {
      const root = document.documentElement;
      if (settings.sectionTitleFontColor) root.style.setProperty('--section-title-font-color', settings.sectionTitleFontColor);
      if (settings.thFontColor)          root.style.setProperty('--th-font-color', settings.thFontColor);
    }

    // ---------- Rendering ----------
    function buildTable() {
      applyTheme();
      applyTypography();
      applyWidgetColors();
      renderHeaderTitle();

      const tbody = $('#tableBody');
      tbody.innerHTML = '';

      const rows = parseLines(settings.rowsContent);
      const options = parseLines(settings.statusOptions);
      const whitelist = new Set(parseLines(settings.autoDateOnOptions).map(s => s.toLowerCase()));
      const autoOnAny = whitelist.size === 0;

      rows.forEach((rowHtml, idx) => {
        const tr = document.createElement('tr');

        // Task cell
        const tdTask = document.createElement('td');
        tdTask.className = 'task-html';
        tdTask.innerHTML = rowHtml;
        tdTask.querySelectorAll('a[href]').forEach(a => {
          a.setAttribute('target', '_blank');
          a.setAttribute('rel', 'noopener noreferrer');
        });

        // Status cell
        const tdStatus = document.createElement('td');
        const statusWrap = document.createElement('div');
        statusWrap.className = 'status-list';
        const groupName = `status_row_${idx}`;

        options.forEach((opt, oi) => {
          const id = `${groupName}_${oi}`;
          const label = document.createElement('label');
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = groupName;
          radio.value = opt;
          radio.id = id;
          label.setAttribute('for', id);
          label.appendChild(radio);
          label.appendChild(document.createTextNode(' ' + opt));
          statusWrap.appendChild(label);
        });
        tdStatus.appendChild(statusWrap);

        // Date cell
        const tdDate = document.createElement('td');
        const date = document.createElement('input');
        date.type = 'date';
        date.placeholder = 'dd/mm/yyyy';
        date.id = `date_row_${idx}`;
        tdDate.appendChild(date);

        // Auto-date behaviour
        statusWrap.addEventListener('change', (e) => {
          const chosen = ((e.target && e.target.value) || '').toLowerCase();
          if (autoOnAny || whitelist.has(chosen)) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            date.value = `${yyyy}-${mm}-${dd}`;
          }
          if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.onInteract) {
            try { JFCustomWidget.onInteract(); } catch(_){}
          }
        });

        // Restore previous values (edit)
        const prior = getPrior(idx);
        if (prior) {
          const sel = getRadioByValue(statusWrap, prior.status);
          if (sel) sel.checked = true;
          if (prior.date) date.value = prior.date;
        }

        tr.appendChild(tdTask);
        tr.appendChild(tdStatus);
        tr.appendChild(tdDate);
        tbody.appendChild(tr);
      });

      requestResize();
    }

    function requestResize() {
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.requestFrameResize) {
        const h = Math.ceil(document.documentElement.scrollHeight);
        try { JFCustomWidget.requestFrameResize({ height: Math.max(280, h) }); } catch(_){}
      }
    }

    function collectValue() {
      const rows = parseLines(settings.rowsContent);
      return rows.map((rowHtml, idx) => {
        const status = document.querySelector(`input[name="status_row_${idx}"]:checked`);
        const date = document.querySelector(`#date_row_${idx}`);
        return {
          taskHtml: rowHtml,
          taskText: stripHtml(rowHtml),
          status: status ? status.value : '',
          date: date ? (date.value || '') : ''
        };
      });
    }

    function getPrior(idx) {
      if (!initialValue || !Array.isArray(initialValue)) return null;
      return initialValue[idx] || null;
    }

    // ---------- Jotform helpers ----------
    function readSettings() {
      const get = (key, dflt='') => {
        try {
          const v = JFCustomWidget.getWidgetSetting(key);
          return (v !== undefined && v !== null && String(v).length) ? v : dflt;
        } catch(_) { return dflt; }
      };
      settings.rowsContent           = get('rows', settings.rowsContent);
      settings.statusOptions         = get('statusOptions', settings.statusOptions);
      settings.headerColor           = get('headerColor', settings.headerColor);
      settings.headerTitle           = get('headerTitle', settings.headerTitle);
      settings.autoDateOnOptions     = get('autoDateOnOptions', settings.autoDateOnOptions);
      settings.formFontFamily        = get('formFontFamily', settings.formFontFamily);
      settings.formFontSize          = get('formFontSize',   settings.formFontSize);
      settings.sectionTitleFontColor = get('sectionTitleFontColor', settings.sectionTitleFontColor);
      settings.thFontColor           = get('thFontColor',           settings.thFontColor);

      const table = $('#statusTable');
      table.setAttribute('aria-label', settings.headerTitle);
    }

    function readInitialValue() {
      try {
        const defVal = JFCustomWidget.getDefaultValue && JFCustomWidget.getDefaultValue();
        if (defVal) {
          const parsed = JSON.parse(defVal);
          if (Array.isArray(parsed)) initialValue = parsed;
          else if (parsed && Array.isArray(parsed.rows)) initialValue = parsed.rows;
        }
      } catch(_){}
    }

    function initStandalone() { buildTable(); }

    // ✅ UPDATED initJotform (submit after ready + guard + no duplicate outer braces)
    function initJotform() {
      JFCustomWidget.subscribe('ready', function () {
        window.__statusTableReadyFired = true;

        readSettings();
        readInitialValue();
        buildTable();

        // Bind submit once
        if (!window.__statusTableSubmitBound) {
          window.__statusTableSubmitBound = true;

          // ✅ Neat plain text submit (no box table)
          JFCustomWidget.subscribe('submit', function () {
  try {
    const rows = collectValue() || [];

    // column widths tuned for Jotform PDFs
    const COL_TASK   = 48;
    const COL_STATUS = 12;
    const COL_DATE   = 10;

    const pad = (txt, len) => {
      txt = String(txt || '');
      return txt.length > len ? txt.slice(0, len - 1) + '…' : txt.padEnd(len, ' ');
    };

    const lines = [];
    lines.push('TRAINING AREAS AND TASKS');
    lines.push('');

    // section header
    const title = (settings.headerTitle || 'INDUCTION TASKS').toUpperCase();
    lines.push(title);
    lines.push('-'.repeat(COL_TASK + COL_STATUS + COL_DATE + 2));
    lines.push(
      pad('Task', COL_TASK) + ' ' +
      pad('Status', COL_STATUS) + ' ' +
      pad('Date', COL_DATE)
    );

    rows.forEach(r => {
      const task   = r.taskText || stripHtml(r.taskHtml);
      const status = r.status || '—';
      const date   = isoToAU(r.date) || '—';

      if (!task) return;

      lines.push(
        pad(task, COL_TASK) + ' ' +
        pad(status, COL_STATUS) + ' ' +
        pad(date, COL_DATE)
      );
    });

    const output = lines.join('\n').trim();

    JFCustomWidget.sendSubmit({
      valid: true,
      value: output
    });

  } catch (e) {
    // never let the widget submit empty
    JFCustomWidget.sendSubmit({ valid: true, value: ' ' });
  }
        }

        // resize hooks
        window.addEventListener('load', requestResize);
        if (window.ResizeObserver) {
          new ResizeObserver(requestResize).observe(document.documentElement);
        }
      });
    }

    // ✅ UPDATED boot: no extra stray listeners/braces; keeps fallback
    (function boot() {
      const hasAPI = !!(window.JFCustomWidget && typeof JFCustomWidget.subscribe === 'function');

      if (hasAPI) {
        window.__statusTableReadyFired = false;
        initJotform();

        setTimeout(() => {
          if (!window.__statusTableReadyFired) {
            console.warn('[Status Table] Jotform "ready" not received — rendering standalone.');
            initStandalone();
          }
        }, 1000);
      } else {
        initStandalone();
      }
    })();
  </script>

</body>
</html>

